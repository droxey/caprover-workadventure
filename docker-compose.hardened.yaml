version: '3.8'

# ===========================================
# SECURITY-HARDENED WorkAdventure + LiveKit
# ===========================================
# Features:
# - Resource limits (CPU/RAM) to prevent DoS
# - Security options (no-new-privileges)
# - Rate limiting via nginx reverse proxy
# - Redis password protection
# - Isolated Docker network
# - Health checks on all services
# - Log rotation
# - Read-only filesystems where possible

x-common-security: &common-security
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  pids_limit: 100

x-logging: &logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

x-resource-small: &resource-small
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 256M
      reservations:
        cpus: '0.1'
        memory: 64M

x-resource-medium: &resource-medium
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 512M
      reservations:
        cpus: '0.25'
        memory: 128M

x-resource-large: &resource-large
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 1G
      reservations:
        cpus: '0.5'
        memory: 256M

networks:
  workadventure:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
  traefik-public:
    external: true

volumes:
  redis-data:
  map-storage:

services:
  # ===========================================
  # TRAEFIK - Reverse Proxy + TLS
  # ===========================================
  traefik:
    image: traefik:v3.0
    <<: [*logging]
    command:
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.bufferingsize=100"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
      - ./logs/traefik:/var/log/traefik
    networks:
      - workadventure
      - traefik-public
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ===========================================
  # NGINX RATE LIMITER - DoS Protection
  # ===========================================
  nginx-ratelimit:
    image: nginx:alpine
    <<: [*common-security, *resource-small, *logging]
    cap_add:
      - NET_BIND_SERVICE
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      play:
        condition: service_healthy
    networks:
      - workadventure
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ===========================================
  # REDIS - Session Store
  # ===========================================
  redis:
    image: redis:7-alpine
    <<: [*common-security, *resource-small, *logging]
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
    volumes:
      - redis-data:/data
    networks:
      - workadventure
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================
  # LIVEKIT - Video Server
  # ===========================================
  livekit:
    image: livekit/livekit-server:v1.7
    <<: [*resource-large, *logging]
    command: |
      --config /etc/livekit.yaml
      --bind 0.0.0.0
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    ports:
      - "7880:7880"
      - "7881:7881"
      - "50000-50100:50000-50100/udp"
    networks:
      - workadventure
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.livekit.rule=Host(`livekit.${DOMAIN}`)"
      - "traefik.http.routers.livekit.entrypoints=websecure"
      - "traefik.http.routers.livekit.tls.certresolver=letsencrypt"
      - "traefik.http.services.livekit.loadbalancer.server.port=7880"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:7880/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ===========================================
  # PLAY - Main Application
  # ===========================================
  play:
    image: thecodingmachine/workadventure-play:${VERSION:-v1.20.0}
    <<: [*common-security, *resource-medium, *logging]
    depends_on:
      redis:
        condition: service_healthy
      back:
        condition: service_healthy
      livekit:
        condition: service_healthy
    environment:
      DEBUG_MODE: 'false'
      PLAY_URL: https://play.${DOMAIN}
      PUBLIC_MAP_STORAGE_URL: https://map-storage.${DOMAIN}
      INTERNAL_MAP_STORAGE_URL: http://map-storage:3000
      SECRET_KEY: ${SECRET_KEY}
      API_URL: back:50051
      LIVEKIT_URL: wss://livekit.${DOMAIN}
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      ENABLE_OPENID: 'false'
      ENABLE_ANONYMOUS: ${ENABLE_ANONYMOUS:-true}
      MAX_USERS_PER_ROOM: ${MAX_USERS_PER_ROOM:-50}
      MAX_PER_GROUP: 4
      SECURITY_EMAIL: ${ACME_EMAIL}
    networks:
      - workadventure
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.play.rule=Host(`play.${DOMAIN}`)"
      - "traefik.http.routers.play.entrypoints=websecure"
      - "traefik.http.routers.play.tls.certresolver=letsencrypt"
      - "traefik.http.services.play.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:3000/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # BACK - API Server
  # ===========================================
  back:
    image: thecodingmachine/workadventure-back:${VERSION:-v1.20.0}
    <<: [*common-security, *resource-medium, *logging]
    depends_on:
      redis:
        condition: service_healthy
    environment:
      SECRET_KEY: ${SECRET_KEY}
      PLAY_URL: https://play.${DOMAIN}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      LIVEKIT_URL: wss://livekit.${DOMAIN}
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET}
      MAX_USERS_PER_ROOM: ${MAX_USERS_PER_ROOM:-50}
    networks:
      - workadventure
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # MAP-STORAGE - Map Management
  # ===========================================
  map-storage:
    image: thecodingmachine/workadventure-map-storage:${VERSION:-v1.20.0}
    <<: [*common-security, *resource-small, *logging]
    volumes:
      - map-storage:/maps
    environment:
      SECRET_KEY: ${SECRET_KEY}
      AUTHENTICATION_STRATEGY: Basic
      AUTHENTICATION_USER: ${MAP_STORAGE_USER:-admin}
      AUTHENTICATION_PASSWORD: ${MAP_STORAGE_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    networks:
      - workadventure
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.map-storage.rule=Host(`map-storage.${DOMAIN}`)"
      - "traefik.http.routers.map-storage.entrypoints=websecure"
      - "traefik.http.routers.map-storage.tls.certresolver=letsencrypt"
      - "traefik.http.services.map-storage.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:3000/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
